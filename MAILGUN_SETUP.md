# Настройка Mailgun для приема входящих писем

## Шаг 1: Создание аккаунта Mailgun

1. Зарегистрируйтесь на https://www.mailgun.com/
2. Подтвердите email
3. Получите бесплатный план (до 5000 писем в месяц)

## Шаг 2: Использование Sandbox домена (для тестирования)

**Для быстрого старта используйте sandbox домен Mailgun:**

Ваш sandbox домен: `sandbox0c4ee941e06a4d218f03c55397b22975.mailgun.org`

**Преимущества sandbox:**
- ✅ Готов к использованию сразу после регистрации
- ✅ Не требует настройки DNS
- ✅ Идеально для тестирования и разработки

**Ограничения sandbox:**
- ⚠️ Можно отправлять только на авторизованные email (добавьте их в Mailgun)
- ⚠️ Для продакшна нужен собственный домен

**Как авторизовать получателей:**
1. В панели Mailgun → **Sending → Authorized Recipients**
2. Добавьте email адреса, на которые хотите отправлять тестовые письма
3. Подтвердите адреса через письмо от Mailgun

---

## Шаг 2 (альтернатива): Добавление собственного домена (для продакшна)

Если нужен продакшн с неограниченными получателями:

1. В панели Mailgun перейдите в **Sending → Domains**
2. Нажмите **Add New Domain**
3. Введите ваш домен (например, `yourdomain.com`)
4. Следуйте инструкциям по настройке DNS-записей:
   - Добавьте TXT записи для SPF и DKIM
   - Добавьте MX записи для приема писем
   - Добавьте CNAME запись для отслеживания

**Пример DNS-записей:**
```
MX   @   10 mxa.mailgun.org
MX   @   10 mxb.mailgun.org
TXT  @   "v=spf1 include:mailgun.org ~all"
TXT  k1._domainkey   "k=rsa; p=MIGfMA0GCS..."
```

5. Дождитесь верификации домена (обычно 5-15 минут)

## Шаг 3: Настройка Webhook в Mailgun

1. В панели Mailgun перейдите в **Sending → Webhooks**
2. Выберите ваш домен (`sandbox0c4ee941e06a4d218f03c55397b22975.mailgun.org` или свой)
3. Найдите секцию **Incoming Messages** (или **Delivered Messages**)
4. Добавьте URL webhook:
   ```
   https://functions.poehali.dev/59c1f232-2c99-4baa-bea6-70b46dadc4b0
   ```
5. Нажмите **Test Webhook** для проверки

**Важно:** Webhook будет принимать письма от Mailgun автоматически - дополнительные headers не нужны.

## Шаг 4: Получение API ключа

1. Перейдите в **Settings → API Keys**
2. Скопируйте **Private API key** (начинается с `key-...`)
3. Вставьте ключ в секрет `MAILGUN_API_KEY` в вашем проекте

**Пример ключа:**
```
key-1234567890abcdef1234567890abcd
```

## Шаг 5: Настройка Routes для входящих писем

**⚠️ ОБЯЗАТЕЛЬНО для приема входящих писем:**

1. Перейдите в **Sending → Routes**
2. Нажмите **Create Route**
3. Настройте:
   - **Expression Type**: Match Recipient
   - **Recipient**: `.*@sandbox0c4ee941e06a4d218f03c55397b22975.mailgun.org` (для sandbox) или `.*@yourdomain.com` (для своего домена)
   - **Actions**: 
     - Выберите **Forward**
     - URL: `https://functions.poehali.dev/59c1f232-2c99-4baa-bea6-70b46dadc4b0`
   - **Priority**: 0
4. Нажмите **Create Route**

**Это критично!** Без роута письма не будут попадать в ваш webhook.

## Шаг 6: Проверка работы

**Для sandbox домена:**
1. Отправьте тестовое письмо на адрес вашего sandbox: `test@sandbox0c4ee941e06a4d218f03c55397b22975.mailgun.org`
2. Проверьте в Mailgun **Logs → Logs** - там должно появиться событие "Accepted" и "Delivered"
3. Откройте ваш почтовый клиент и проверьте, что письмо появилось во входящих

**Для собственного домена:**
1. Отправьте письмо на любой адрес вашего домена (например, `user@yourdomain.com`)
2. Проверьте в Mailgun **Logs → Logs**
3. Письмо появится в почтовом клиенте автоматически

## Важные моменты

- **Sandbox домен** Mailgun имеет ограничения - используйте собственный домен для продакшна
- **Верификация домена** обязательна - без неё письма не будут приниматься
- **DNS записи** должны быть корректно настроены - проверьте через `dig` или `nslookup`
- **Webhook подпись** проверяется автоматически для безопасности

## Отладка

Если письма не приходят:

1. Проверьте **Mailgun Logs → Events** - там видны все входящие письма
2. Убедитесь, что webhook возвращает статус 200
3. Проверьте DNS записи командой: `dig MX yourdomain.com`
4. Проверьте, что в вашем проекте добавлен секрет `MAILGUN_API_KEY`
5. Посмотрите логи backend функции в poehali.dev

## Альтернатива: SendGrid

Если Mailgun не подходит, можно использовать SendGrid:

1. Зарегистрируйтесь на https://sendgrid.com/
2. Добавьте домен и настройте DNS
3. Создайте Inbound Parse Webhook с аналогичным URL
4. Обновите код webhook для работы с форматом SendGrid

---

**Готово!** Теперь все письма на ваш домен будут автоматически попадать в базу данных и отображаться в почтовом клиенте.