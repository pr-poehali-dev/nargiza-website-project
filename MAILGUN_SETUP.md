# Настройка Mailgun для приема входящих писем

## Шаг 1: Создание аккаунта Mailgun

1. Зарегистрируйтесь на https://www.mailgun.com/
2. Подтвердите email
3. Получите бесплатный план (до 5000 писем в месяц)

## Шаг 2: Добавление домена

1. В панели Mailgun перейдите в **Sending → Domains**
2. Нажмите **Add New Domain**
3. Введите ваш домен (например, `yourdomain.com`)
4. Следуйте инструкциям по настройке DNS-записей:
   - Добавьте TXT записи для SPF и DKIM
   - Добавьте MX записи для приема писем
   - Добавьте CNAME запись для отслеживания

**Пример DNS-записей:**
```
MX   @   10 mxa.mailgun.org
MX   @   10 mxb.mailgun.org
TXT  @   "v=spf1 include:mailgun.org ~all"
TXT  k1._domainkey   "k=rsa; p=MIGfMA0GCS..."
```

5. Дождитесь верификации домена (обычно 5-15 минут)

## Шаг 3: Настройка Webhook в Mailgun

1. В панели Mailgun перейдите в **Sending → Webhooks**
2. Выберите ваш домен
3. Найдите секцию **Incoming Messages**
4. Добавьте URL webhook:
   ```
   https://functions.poehali.dev/59c1f232-2c99-4baa-bea6-70b46dadc4b0
   ```
5. В Headers добавьте:
   - Key: `X-Mailgun-Webhook`
   - Value: `true`
6. Нажмите **Test Webhook** для проверки

## Шаг 4: Получение API ключа

1. Перейдите в **Settings → API Keys**
2. Скопируйте **Private API key** (начинается с `key-...`)
3. Вставьте ключ в секрет `MAILGUN_API_KEY` в вашем проекте

**Пример ключа:**
```
key-1234567890abcdef1234567890abcd
```

## Шаг 5: Настройка Routes (опционально)

Если вы хотите, чтобы ВСЕ письма на ваш домен попадали в webhook:

1. Перейдите в **Sending → Routes**
2. Нажмите **Create Route**
3. Настройте:
   - **Expression Type**: Match Recipient
   - **Recipient**: `.*@yourdomain.com` (регулярное выражение)
   - **Actions**: Forward → добавьте URL webhook
   - **Priority**: 0
4. Сохраните

## Шаг 6: Проверка работы

1. Отправьте тестовое письмо на любой адрес вашего домена (например, `test@yourdomain.com`)
2. Проверьте в Mailgun **Logs → Events**, что письмо было получено
3. Зайдите в админ-панель вашего почтового клиента и проверьте, что письмо появилось в базе

## Важные моменты

- **Sandbox домен** Mailgun имеет ограничения - используйте собственный домен для продакшна
- **Верификация домена** обязательна - без неё письма не будут приниматься
- **DNS записи** должны быть корректно настроены - проверьте через `dig` или `nslookup`
- **Webhook подпись** проверяется автоматически для безопасности

## Отладка

Если письма не приходят:

1. Проверьте **Mailgun Logs → Events** - там видны все входящие письма
2. Убедитесь, что webhook возвращает статус 200
3. Проверьте DNS записи командой: `dig MX yourdomain.com`
4. Проверьте, что в вашем проекте добавлен секрет `MAILGUN_API_KEY`
5. Посмотрите логи backend функции в poehali.dev

## Альтернатива: SendGrid

Если Mailgun не подходит, можно использовать SendGrid:

1. Зарегистрируйтесь на https://sendgrid.com/
2. Добавьте домен и настройте DNS
3. Создайте Inbound Parse Webhook с аналогичным URL
4. Обновите код webhook для работы с форматом SendGrid

---

**Готово!** Теперь все письма на ваш домен будут автоматически попадать в базу данных и отображаться в почтовом клиенте.
